{% extends base_template %}
{% block title_page %}AL - Dashboard{% endblock %}
{% block css_import %}
    <style type="text/css">
        .gauge {
            width: 140px;
            height: 75px;
        }

        .chart-filled-cpu {
            fill: #357ebd;
        }

        .chart-filled-ram {
            fill: #31708f;
        }

        .chart-empty {
            fill: #b7b7b752;
        }

        .needle, .needle-center {
            fill: #464A4F;
        }

        svg {
            font: 10px sans-serif;
        }
    </style>
{% endblock %}
{% block js_import %}
	<script src="/static/js/d3/d3.v3.min.js"></script>
	<script src="/static/js/d3/d3_gauge.js"></script>
	<script src="/static/js/socket.io/socket.io.slim.js"></script>
	<script src="/static/js/socket.io/ng-socket.js"></script>
	<script src="/static/js/dashboard.js"></script>
{% endblock %}

{% block section %}
	<div class="table" style="padding-top: 80px;" style="width: 99%;">
    {%raw%}
        <div class="row" style="margin: 0;">
            <div class="col-lg-6 col-sm-12">
                <div class="dashboard_card dashboard_card_big" ng-class="{disabled: data.ingester.count==0,ok: data.ingester.count!=0&&!ingester_in_error(data.ingester), error: data.ingester.count!=0&&ingester_in_error(data.ingester)}">
                    <div class="row ">
                        <div class="title col-sm-11 col-xs-10">Ingester :: x{{data.ingester.count}}</div>
                        <div ng-show="data.ingester.count!=0&&ingester_in_error(data.ingester)" class="col-sm-1 col-xs-2 text-right"><span class="text-danger text-icon icon-erroralt"></span></div>
                    </div>
                    <div class="row ">
                        <div class="col-sm-3 col-xs-12">
                            <div><label>Ingest:</label></div>
                            <div>
                                <span title="Ingest Queue" ng-class="{'text-muted': data.ingester.queues.ingest <= 100000, 'text-danger': data.ingester.queues.ingest > 100000}" class="text-icon icon-squarei"></span><span ng-class="{'text-danger': data.ingester.queues.ingest > 100000}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.queues.ingest}}&nbsp;</span>&nbsp;
                            </div>
                        </div>
                        <div class="col-sm-6 col-xs-12">
                            <div><label>Queued:</label></div>
                            <div>
                                <span title="Critical Priority Files Waiting" ng-class="{'text-muted': data.ingester.processing_chance.critical==1, 'text-danger': data.ingester.processing_chance.critical!=1}" class="text-icon icon-squarec"></span><span ng-class="{'text-danger': data.ingester.processing_chance.critical!=1}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.queues.critical}}&nbsp;</span><span class="text-danger" ng-show="data.ingester.processing_chance.critical!=1" style="vertical-align: top; font-size: 11pt;">({{data.ingester.processing_chance.critical * 100 | floatStr}}%)&nbsp;</span>&nbsp;
                                <span title="High Priority Files Waiting" ng-class="{'text-muted': data.ingester.processing_chance.high==1, 'text-danger': data.ingester.processing_chance.high!=1}" class="text-icon icon-squareh"></span><span ng-class="{'text-danger': data.ingester.processing_chance.high!=1}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.queues.high}}&nbsp;</span><span class="text-danger" ng-show="data.ingester.processing_chance.high!=1" style="vertical-align: top; font-size: 11pt;">({{data.ingester.processing_chance.high * 100 | floatStr}}%)&nbsp;</span>&nbsp;
                                <span title="Medium Priority Files Waiting" ng-class="{'text-muted': data.ingester.processing_chance.medium==1, 'text-danger': data.ingester.processing_chance.medium!=1}" class="text-icon icon-squarem"></span><span ng-class="{'text-danger': data.ingester.processing_chance.medium!=1}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.queues.medium}}&nbsp;</span><span class="text-danger" ng-show="data.ingester.processing_chance.medium!=1" style="vertical-align: top; font-size: 11pt;">({{data.ingester.processing_chance.medium * 100 | floatStr}}%)&nbsp;</span>&nbsp;
                                <span title="Low Priority Files Waiting" ng-class="{'text-muted': data.ingester.processing_chance.low==1, 'text-danger': data.ingester.processing_chance.low!=1}" class="text-icon icon-squarel"></span><span ng-class="{'text-danger': data.ingester.processing_chance.low!=1}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.queues.low}}&nbsp;</span><span class="text-danger" ng-show="data.ingester.processing_chance.low!=1" style="vertical-align: top; font-size: 11pt;">({{data.ingester.processing_chance.low * 100 | floatStr}}%)&nbsp;</span>&nbsp;
                            </div>
                        </div>
                        <div class="col-sm-3 col-xs-12">
                            <div><label>Processing:</label></div>
                            <div>
                                <span title="Inflight Submissions" class="text-muted text-icon icon-squarei"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.processing.inflight}}&nbsp;</span>
                                <span title="Waiting for Submission" class="text-muted text-icon icon-squarew"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.processing.waiting}}&nbsp;</span>
                            </div>
                        </div>
                    </div>
                    <div class="row ">
                        <div class="col-sm-3 col-xs-12">
                        </div>
                        <div class="col-sm-9 col-xs-12">
                            <div><label>Throughput: (for the last minute)</label></div>
                            <div>
                                <span title="Completed files" class="text-muted text-icon icon-squaref"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.files_completed | floatStr}}&nbsp;</span>&nbsp;
                                <span title="Completed submissions" class="text-muted text-icon icon-squarec"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.submissions_completed | floatStr}}&nbsp;</span>&nbsp;
                                <span title="Whitelisted files" class="text-muted text-icon icon-squarew"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.whitelisted | floatStr}}&nbsp;</span>&nbsp;
                                <span title="Skipped files" class="text-muted text-icon icon-squares"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.skipped | floatStr}}&nbsp;</span>&nbsp;
                                <span title="Duplicate files" class="text-muted text-icon icon-squared"></span><span style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.duplicates | floatStr}}&nbsp;</span>
                                <span ng-class="{'text-muted': data.ingester.count==0||data.ingester.counters.bytes_completed != 0, 'text-danger': data.ingester.count!=0&&data.ingester.counters.bytes_completed == 0}" class="text-icon icon-speed"></span><span ng-class="{'text-danger': data.ingester.count!=0&&data.ingester.counters.bytes_completed == 0}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.ingester.counters.bytes_completed/((1024*1024*60)/8) | floatStr}} / {{data.ingester.counters.bytes_ingested/((1024*1024*60)/8) | floatStr}} Mbps</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-sm-12 ">
                <div class="dashboard_card dashboard_card_big" ng-class="{ok: !dispatcher_in_error(data.dispatcher), error: dispatcher_in_error(data.dispatcher), disabled: data.dispatcher.count==0}">
                    <div ng-show="dispatcher_in_error(data.dispatcher)" class="pull-right"><span class="text-danger text-icon icon-erroralt"></span></div>
                    <div class="title">Dispatcher :: x{{data.dispatcher.count}}</div>

                    <div class="row">
                        <div class="col-xs-12">
                            <div><label>Services:</label></div>
                            <div>
                                {{ data.services.up | split }}
                                <span ng-show="data.services.up.length>0&&data.services.down.length>0"> :: </span><span class="text-muted">{{ data.services.down | split }}</span>
                            </div>
                        </div>
                        <div class="col-sm-4 col-xs-12">
                            <div><label>Submissions:</label></div>
                            <div>
                                {{data.dispatcher.inflight.outstanding}}&nbsp;/&nbsp;{{data.dispatcher.inflight.max}}
                            </div>
                        </div>
                        <div class="col-sm-4 col-xs-12">
                            <div><label>Queues:</label></div>
                            <div>
                                <span title="Ingest Queue" ng-class="{'text-danger': data.dispatcher.queues.ingest>=data.dispatcher.inflight.outstanding&&data.dispatcher.count>0, 'text-muted': data.dispatcher.queues.ingest<data.dispatcher.inflight.outstanding||data.dispatcher.count==0}" class="text-icon icon-squarei"></span><span ng-class="{'text-danger': data.dispatcher.queues.ingest>=data.dispatcher.inflight.outstanding&&data.dispatcher.count>0}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.dispatcher.queues.ingest}}&nbsp;</span>
                                <span title="Response Queue" ng-class="{'text-danger': data.dispatcher.queues.response>=data.dispatcher.inflight.outstanding&&data.dispatcher.count>0, 'text-muted': data.dispatcher.queues.response<data.dispatcher.inflight.outstanding||data.dispatcher.count==0}" class="text-muted text-icon icon-squarer"></span><span ng-class="{'text-danger': data.dispatcher.queues.response>=data.dispatcher.inflight.outstanding&&data.dispatcher.count>0}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.dispatcher.queues.response}}&nbsp;</span>
                                <span title="Control Queue" ng-class="{'text-danger': data.dispatcher.queues.control>0, 'text-muted': data.dispatcher.queues.control==0}" class="text-muted text-icon icon-squarec"></span><span ng-class="{'text-danger': data.dispatcher.queues.control>0}" style="vertical-align: top; font-size: 11pt;">&nbsp;{{data.dispatcher.queues.control}}&nbsp;</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" style="margin: 0;">
            <div  ng-repeat="(service_name, service) in data.services.metrics">
                <div ng-if="data.services.up.indexOf(service_name) != -1" class="col-lg-2 col-md-3 col-sm-6 col-xs-12">
                    <div class="dashboard_card" ng-class="{error: has_errors(service), ok: !has_errors(service)}">
                        <div class="pull-right"><span ng-show="has_errors(service)" class="text-danger text-icon icon-erroralt">&nbsp;&nbsp;</span></div>
                        <div class="title" style="padding-bottom: 10px">{{service_name}}</div>
                        <div class="row">
                            <div ng-class="{'text-danger': service.queue>(data.dispatcher.inflight.outstanding/2)}" class="col-xs-12" title="Number of items in the service's queue"><span ng-class="{'text-muted': !service.queue>(data.dispatcher.inflight.outstanding/2)}" class="text-icon icon-squareq"></span>&nbsp;<span style="vertical-align: top; font-size: 11pt;">{{service.queue}}</span></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-4" title="Number of processed items in the last minute"><span class="text-icon icon-squarep"></span>&nbsp;<span style="vertical-align: top; font-size: 11pt;">{{service.counters.processed}}</span></div>
                            <div class="col-xs-4" title="Number of cache hits in the last minute"><span class="text-icon icon-squarec"></span>&nbsp;<span style="vertical-align: top; font-size: 11pt;">{{service.counters.cached}}</span></div>
                            <div ng-class="{'text-danger': service.counters.failed>0}" class="col-xs-4" title="Number of failed items in the last minute"><span ng-class="{'text-muted': service.counters.failed==0}" class="text-icon icon-squaref"></span>&nbsp;<span style="vertical-align: top; font-size: 11pt;">{{service.counters.failed}}</span></div>
                        </div>
                    </div>
                </div>
                <div ng-if="data.services.down.indexOf(service_name) != -1" class="col-lg-2 col-md-3 col-sm-6 col-xs-12">
                    <div class="dashboard_card disabled" >
                        <div class="title" style="padding-bottom: 10px">{{service_name}}</div>
                        <div class="pad text-large text-center text-muted">
                            OFFLINE
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="margin: 0;">
            <div class="bigpad ng-hide container" ng-show="loading">
                <div class="bigpad jumbotron text-center">
                    <h2 class="text-muted">Loading</h2>
                    <div class="throbber">
                        Loading
                    </div>
                </div>
            </div>
        </div>
	{%endraw%}
	</div>
{% endblock %}
		
